<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
<title>使用 Kubeadm 快速创建 K8S 集群 - Untitled</title>
<meta name="description" content="温故而知新">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link type='text/css' rel='stylesheet' href='https://m01i0ng.js.org/styles/main.css' media='screen' />
<link type="text/css" rel="stylesheet" href="https://cdn.bootcss.com/KaTeX/0.11.1/katex.min.css">
<link type="text/css" rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css">

<script type="text/javascript" src='https://m01i0ng.js.org/media/scripts/jquery.js'></script>
<script type="text/javascript" src="https://cdn.bootcss.com/highlight.js/9.15.10/highlight.min.js"></script>

<script>
    hljs.initHighlightingOnLoad();
</script>
</head>

<body>
  <div class="layout theme-dark">
    <div class="layout-header">

	<div class="layout-header-main">
		<div class="container">
			<div class="row justify-content-lg-center">
				<div class="col-12 col-lg-9">

					<div class="navbar">

						<div class="logo">
							<a href="https://m01i0ng.js.org">
								<img class="logo"
									src="https://m01i0ng.js.org/media/images/site_avatar.png?v=1590130567436"
									alt="">
							</a>
						</div>

						<div class="menu d-md-inline-block d-none">
							<ul class="layout-navigation-list">
								
								<li class="layout-navigation-item"><a title="首页"
										href="/">首页</a>
								</li>
								
								<li class="layout-navigation-item"><a title="归档"
										href="/archives">归档</a>
								</li>
								
								<li class="layout-navigation-item"><a title="标签"
										href="/tags">标签</a>
								</li>
								
								<li class="layout-navigation-item"><a title="关于"
										href="/post/about">关于</a>
								</li>
								
							</ul>
						</div>

						<div class="item d-md-inline-block d-none">
							<div class="search-icon">
								<i class="fa fa-search" aria-hidden="true"></i>
							</div>
						</div>



						<div class="d-md-inline-block d-none">
							<div class="search-lightbox">
								<div class="search-body">

									<form id="gridea-search-form" data-update="1590130567436" action="/search/" class="search-form">
										<input type="text" name="q" id="s" value="" class="search-field" placeholder="请输入搜索关键词" aria-label="请输入搜索关键词" required="">
										<button type="submit" class="submit" aria-label="Submit">
											<i class="fa fa-search" aria-hidden="true"></i>
										</button>
									</form>

								</div>
							</div>
						</div>

						<div class="nav d-md-none d-inline-block">
							<div class="trigger">
								<i class="fa fa-bars layout-btn-toggle" aria-hidden="true"></i>
							</div>
						</div>

					</div>

				</div>
			</div>




		</div>
	</div>

</div>
    <div class="layout-collapse d-md-none">
	<div class="layout-collapse-main">
		<ul class="layout-collapse-list">
			
			<li class="layout-collapse-item"><a title="首页" href="/">首页</a></li>
			
			<li class="layout-collapse-item"><a title="归档" href="/archives">归档</a></li>
			
			<li class="layout-collapse-item"><a title="标签" href="/tags">标签</a></li>
			
			<li class="layout-collapse-item"><a title="关于" href="/post/about">关于</a></li>
			

		</ul>
	</div>
</div>

    <div class="layout-content">
      <div class="layout-content-main">
        <div class="container">
          <div class="row justify-content-lg-center">
            <div class="col-12 col-lg-9">
              <div class="layout-post">
                <div class="layout-post-body">
                  <div class="row">

                    <div class="col-12 col-lg-10">
                      <div class="layout-post-main m-right m-md-right">
                        <div class="layout-post-header">
                          <h1 class="layout-post-title">使用 Kubeadm 快速创建 K8S 集群</h1>
                          <div class="layout-post-meta">
                            <div class="item">
                               <a href="https://m01i0ng.js.org/tag/LbGnNImX8/" class="post--keyword"
                                data-title="k8s" data-type="post_tag" data-term-id="39">k8s</a>
                               <a href="https://m01i0ng.js.org/tag/sPUrg8x7B/" class="post--keyword"
                                data-title="Docker" data-type="post_tag" data-term-id="39">Docker</a>
                              
                            </div>
                            <div class="item">
                              <span>2020-02-08</span>
                            </div>
                          </div>
                        </div>
                        <div class="layout-post-content">
                          <div class="layout-post-item">
                            
                            <h2 id="环境架构">环境架构</h2>
<h3 id="服务器">服务器</h3>
<ul>
<li>192.168.1.220 k8s-master</li>
<li>192.168.1.221 k8s-node-1</li>
<li>192.168.1.223 k8s-node-2</li>
</ul>
<h3 id="系统centos-74">系统：centos 7.4</h3>
<h3 id="集群部署方式kubeadm">集群部署方式：kubeadm</h3>
<h2 id="系统配置">系统配置</h2>
<h3 id="配置主机映射">配置主机映射</h3>
<p>所有节点</p>
<pre><code class="language-bash">cat &gt; /etc/hosts &lt;&lt; EOF
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6

192.168.1.220 k8s-master
192.168.1.221 k8s-node-1
192.168.1.223 k8s-node-2
EOF
</code></pre>
<h3 id="禁用-selinux">禁用 selinux</h3>
<p>所有节点</p>
<pre><code class="language-bash">sed -i &quot;s/^SELINUX=enforcing/SELINUX=disabled/g&quot; /etc/sysconfig/selinux
sed -i &quot;s/^SELINUX=enforcing/SELINUX=disabled/g&quot; /etc/selinux/config
sed -i &quot;s/^SELINUX=permissive/SELINUX=disabled/g&quot; /etc/sysconfig/selinux
sed -i &quot;s/^SELINUX=permissive/SELINUX=disabled/g&quot; /etc/selinux/config
setenforce 0
</code></pre>
<h3 id="禁用防火墙">禁用防火墙</h3>
<p>所有节点</p>
<pre><code class="language-bash">systemctl disable firewalld &amp;&amp; systemctl stop firewalld
</code></pre>
<h3 id="关闭交换分区">关闭交换分区</h3>
<p>所有节点</p>
<pre><code class="language-bash">sed -i 's/.*swap.*/#&amp;/' /etc/fstab
swapoff -a
</code></pre>
<h3 id="配置转发参数">配置转发参数</h3>
<p>所有节点</p>
<pre><code class="language-bash">cat &gt; /etc/sysctl.d/k8s.conf &lt;&lt; EOF
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
vm.swappiness=0
EOF
sysctl --system
</code></pre>
<h3 id="加载-ipvs-相关内核模块">加载 ipvs 相关内核模块</h3>
<p>所有节点</p>
<pre><code class="language-bash"># 如果重新开机，需要重新加载
modprobe ip_vs
modprobe ip_vs_rr
modprobe ip_vs_wrr
modprobe ip_vs_sh
modprobe nf_conntrack_ipv4
lsmod | grep ip_vs
</code></pre>
<h2 id="安装配置-docker">安装配置 Docker</h2>
<p>k8s v1.11.0 版本推荐使用 Docker v17.03，经测试 v1.13 也能正常使用，而最新的 v18.05 会产生警告，并无法使用资源限制</p>
<h3 id="安装-docker">安装 Docker</h3>
<p>所有节点</p>
<pre><code class="language-bash">yum install -y docker &amp;&amp;\
systemctl enable docker &amp;&amp;\
systemctl start docker
</code></pre>
<h3 id="配置国内镜像">配置国内镜像</h3>
<p>所有节点</p>
<pre><code class="language-bash">cat &gt; /etc/docker/daemon.json &lt;&lt; EOF
{
  &quot;registry-mirrors&quot;: [&quot;https://docker.mirrors.ustc.edu.cn/&quot;]
}
EOF
systemctl daemon-reload
systemctl restart docker
</code></pre>
<h2 id="安装配置-kubernetes">安装配置 Kubernetes</h2>
<h3 id="安装-kubernetes">安装 Kubernetes</h3>
<p>所有节点</p>
<pre><code class="language-bash"># 配置源
cat &gt; /etc/yum.repos.d/kubernetes.repo &lt;&lt; EOF
[kubernetes]
name=Kubernetes
baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
enabled=1
gpgcheck=1
repo_gpgcheck=1
gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
EOF

# 安装
yum install -y kubelet kubeadm kubectl ipvsadm
</code></pre>
<h3 id="配置启动-kubelet">配置启动 Kubelet</h3>
<p>所有节点</p>
<pre><code class="language-bash"># 配置kubelet使用国内pause镜像
# 配置kubelet的cgroups
# 获取docker的cgroups
DOCKER_CGROUPS=$(docker info | grep 'Cgroup' | cut -d' ' -f3)
echo $DOCKER_CGROUPS
cat &gt; /etc/sysconfig/kubelet &lt;&lt; EOF
KUBELET_EXTRA_ARGS=&quot;--cgroup-driver=$DOCKER_CGROUPS --pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com/google_containers/pause-amd64:3.1&quot;
EOF

# 启动
systemctl daemon-reload
systemctl enable kubelet &amp;&amp; systemctl start kubelet
</code></pre>
<h3 id="配置-master-节点">配置 master 节点</h3>
<p>master 节点</p>
<pre><code class="language-bash"># 生成配置文件
cat &gt; kubeadm-master.config &lt;&lt; EOF
apiVersion: kubeadm.k8s.io/v1alpha2
kind: MasterConfiguration
kubernetesVersion: v1.11.0
imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers
api:
  # master 节点 ip
  advertiseAddress: 192.168.1.220

controllerManagerExtraArgs:
  node-monitor-grace-period: 10s
  pod-eviction-timeout: 10s

networking:
  podSubnet: 10.244.0.0/16

kubeProxy:
  config:
    # mode: ipvs
    mode: iptables
EOF
</code></pre>
<pre><code class="language-bash"># 提前拉取镜像，如果失败可以多次尝试
kubeadm config images pull --config kubeadm-master.config
</code></pre>
<pre><code class="language-bash"># 启动
kubeadm init --config kubeadm-master.config
</code></pre>
<p>如以上命令没有出错，会出现类似 <code>kubeadm --join xxx</code> 的说明</p>
<pre><code class="language-bash">rm -rf $HOME/.kube
mkdir -p $HOME/.kube
cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
chown $(id -u):$(id -g) $HOME/.kube/config
</code></pre>
<p>执行 <code>kubectl get nodes</code> 查看节点，此时状态应该为 NotReady，接着开始配置 <code>flannel</code> 网络插件</p>
<pre><code class="language-bash"># 修改镜像
wgte https://raw.githubusercontent.com/coreos/flannel/v0.10.0/Documentation/kube-flannel.yml
sed -i 's/k8s.gcr.io/registry.cn-shanghai.aliyuncs.com\/gcr-k8s/g' kube-flannel.yaml
</code></pre>
<pre><code class="language-bash"># 部署
kubectl apply -f kube-flannel.yml
</code></pre>
<p>查看（需要时间配置，可反复执行第一条查看直到 <code>pods</code> 状态全为 <code>Running</code>）</p>
<pre><code class="language-bash">kubectl get po -n kube-system
kubectl get svc -n kube-system
</code></pre>
<p>配置好网络之后 kubeadm 会自动部署 coredns，再执行 <code>kubectl get nodes</code>，此时 <code>master</code> 节点状态应该为 <code>Ready</code></p>
<h3 id="配置子节点">配置子节点</h3>
<p>node-1、node-2 节点</p>
<p><code>master</code> 节点执行 <code>kubeadm token create --print-join-command</code>，将结果复制，到 <code>node</code> 上执行，加入集群，如果执行失败可能是 <code>selinux</code> 没关（我在此处困了很久……），最后在 <code>master</code> 节点执行 <code>kubectl get node</code>，应该会看见加入进来的节点</p>
<h2 id="测试集群">测试集群</h2>
<p>master 节点</p>
<p>部署 deploy</p>
<pre><code class="language-bash">kubectl run nginx --replicas=2 --image=nginx:alpine --port=80
kubectl expose deployment nginx --type=NodePort --name=test-service-nodeport
kubectl expose deployment nginx --name=test-service

kubectl describe svc test-service
</code></pre>
<p>访问测试，32340 为上面最后一条命令查看 svc 时获取的端口</p>
<p>浏览器打开 <code>http://&lt;master-ip&gt;:&lt;32340&gt;</code> 会返回 nginx 的欢迎界面</p>
<p>清理删除</p>
<pre><code class="language-bash">kubectl delete svc test-service test-service-nodeport
kubectl delete deploy nginx
</code></pre>
<h2 id="结束">结束</h2>
<ul>
<li>部署完成之后想增加节点只要按照子节点部署的步骤进行即可，之后可以参考官方文档安装 <code>dashboard heapster</code> 等插件</li>
<li>此为单主多子节点配置，多主多子配置方法有所不同，日后再说--</li>
</ul>

                          </div>
                        </div>
                        <div class="layout-post-social">
                          <div class="item reader">
                            <div id="/post/shi-yong-kubeadm-kuai-su-chuang-jian-k8s-ji-qun/" class="leancloud-visitors view"
                              data-flag-title="使用 Kubeadm 快速创建 K8S 集群">
                              <span class="post-meta-item-text">阅读 </span>
                              <span class="leancloud-visitors-count"></span>
                            </div>
                          </div>
                        </div>

                        <div class="layout-post-navigation">
                          <div class="navigation-list">
                            
                            <div class="post-card row">
                              
                              <div class="card-content col-12">
                                <div class="card-body">
                                  <div class="header">
                                    <a href="https://m01i0ng.js.org/linux-gui-na/" class="title">
                                      <h4>Linux 归纳</h4>
                                    </a>
                                  </div>
                                  <div class="inner">
                                    <div class="abstract">
                                      
                                    </div>
                                  </div>
                                </div>
                                <div class="card-footer">
                                  <div class="item"><span>上一篇</span></div>
                                  <div class="item">2020-02-08</div>
                                </div>
                              </div>
                              
                            </div>

                            <div class="post-card row">
                              
                              <div class="card-content col-12">
                                <div class="card-body">
                                  <div class="header">
                                    <a href="https://m01i0ng.js.org/docker-jing-xiang-de-fen-jie-duan-gou-jian/" class="title">
                                      <h4>Docker 镜像的分阶段构建</h4>
                                    </a>
                                  </div>
                                  <div class="inner">
                                    <div class="abstract">
                                      
                                    </div>
                                  </div>
                                </div>
                                <div class="card-footer">
                                  <div class="item"><span>下一篇</span></div>
                                  <div class="item">2020-02-08</div>
                                </div>
                              </div>
                              
                            </div>

                            
                          </div>
                        </div>

                        <div class="layout-comments"></div>
                        
                        <script type="text/javascript" src='https://m01i0ng.js.org/media/scripts/zan.js'></script>
<script type="text/javascript" src='https://m01i0ng.js.org/media/scripts/av-min.js'></script>
<script type="text/javascript" src='https://m01i0ng.js.org/media/scripts/Valine.min.js'></script>

<script>
  var valine = new Valine();
  valine.init({
    el: '.layout-comments',
    appId: 'EYfm3fMEYq4kxvu0c4GsrUsP-gzGzoHsz',
    appKey: 'ToFsSKzpmlf16qEhNPO5XMJy',
    notify: false,
    verify: false,
    visitor: true,
    avatar: 'mp',
    placeholder: '加入讨论...'
  })
</script>
                        
                      </div>
                    </div>

                    <div class="col-12 col-lg-2 d-none d-lg-block">
                      <div class="layout-post-sidebar">
                        <div class="layout-sidebar-item">
                          <ul class="markdownIt-TOC">
<li>
<ul>
<li><a href="#%E7%8E%AF%E5%A2%83%E6%9E%B6%E6%9E%84">环境架构</a>
<ul>
<li><a href="#%E6%9C%8D%E5%8A%A1%E5%99%A8">服务器</a></li>
<li><a href="#%E7%B3%BB%E7%BB%9Fcentos-74">系统：centos 7.4</a></li>
<li><a href="#%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2%E6%96%B9%E5%BC%8Fkubeadm">集群部署方式：kubeadm</a></li>
</ul>
</li>
<li><a href="#%E7%B3%BB%E7%BB%9F%E9%85%8D%E7%BD%AE">系统配置</a>
<ul>
<li><a href="#%E9%85%8D%E7%BD%AE%E4%B8%BB%E6%9C%BA%E6%98%A0%E5%B0%84">配置主机映射</a></li>
<li><a href="#%E7%A6%81%E7%94%A8-selinux">禁用 selinux</a></li>
<li><a href="#%E7%A6%81%E7%94%A8%E9%98%B2%E7%81%AB%E5%A2%99">禁用防火墙</a></li>
<li><a href="#%E5%85%B3%E9%97%AD%E4%BA%A4%E6%8D%A2%E5%88%86%E5%8C%BA">关闭交换分区</a></li>
<li><a href="#%E9%85%8D%E7%BD%AE%E8%BD%AC%E5%8F%91%E5%8F%82%E6%95%B0">配置转发参数</a></li>
<li><a href="#%E5%8A%A0%E8%BD%BD-ipvs-%E7%9B%B8%E5%85%B3%E5%86%85%E6%A0%B8%E6%A8%A1%E5%9D%97">加载 ipvs 相关内核模块</a></li>
</ul>
</li>
<li><a href="#%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE-docker">安装配置 Docker</a>
<ul>
<li><a href="#%E5%AE%89%E8%A3%85-docker">安装 Docker</a></li>
<li><a href="#%E9%85%8D%E7%BD%AE%E5%9B%BD%E5%86%85%E9%95%9C%E5%83%8F">配置国内镜像</a></li>
</ul>
</li>
<li><a href="#%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE-kubernetes">安装配置 Kubernetes</a>
<ul>
<li><a href="#%E5%AE%89%E8%A3%85-kubernetes">安装 Kubernetes</a></li>
<li><a href="#%E9%85%8D%E7%BD%AE%E5%90%AF%E5%8A%A8-kubelet">配置启动 Kubelet</a></li>
<li><a href="#%E9%85%8D%E7%BD%AE-master-%E8%8A%82%E7%82%B9">配置 master 节点</a></li>
<li><a href="#%E9%85%8D%E7%BD%AE%E5%AD%90%E8%8A%82%E7%82%B9">配置子节点</a></li>
</ul>
</li>
<li><a href="#%E6%B5%8B%E8%AF%95%E9%9B%86%E7%BE%A4">测试集群</a></li>
<li><a href="#%E7%BB%93%E6%9D%9F">结束</a></li>
</ul>
</li>
</ul>

                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="layout-totop d-none"><i class="fa fa-angle-up" aria-hidden="true"></i></div>

    	<div class="layout-footer">

		<div class="container">
			<div class="row justify-content-lg-center">
				<div class="col-12 col-lg-9">
					<div class="footer">
						<div class="row">
							<div class="col-12 col-md-9">
								<div class="footer-copy">
									
									Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a>
									<div class="footer-icp d-none d-sm-inline-block">
										<span class="px-2">⋅</span>
										
									</div>
								</div>
							</div>
							<div class="col-sm-3 d-none d-md-block">
								<div class="footer-links">
									
									
									
									
									<span class="footer-links-item">
										<a href="https://github.com/m01i0ng" target="_blank">
											<i class="fa fa-github" aria-hidden="true"></i>
										</a>
									</span>
									
									
									
									
									
									
									
									
									
									
									
									
									
									
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

	</div>

	<script type="text/javascript" src='https://m01i0ng.js.org/media/scripts/main.js'></script>
	

  </div>
</body>

</html>