
<!DOCTYPE html>
<html>
  <head>
    
<meta charset="utf-8" >

<title>使用 Kubeadm 快速创建 K8S 集群 | Untitled</title>
<meta name="description" content="温故而知新">

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.7.0/animate.min.css">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
<link rel="shortcut icon" href="https://m01i0ng.js.org/favicon.ico?v=1581141201590">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
<link rel="stylesheet" href="https://m01i0ng.js.org/styles/main.css">


  
    <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css" />
  

  


<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>



  </head>
  <body>
    <div id="app" class="main">
      <div class="site-header-container">
  <div class="site-header">
    <div class="left">
      <a href="https://m01i0ng.js.org">
        <img class="avatar" src="https://m01i0ng.js.org/images/avatar.png?v=1581141201590" alt="" width="32px" height="32px">
      </a>
      <a href="https://m01i0ng.js.org">
        <h1 class="site-title">Untitled</h1>
      </a>
    </div>
    <div class="right">
      <transition name="fade">
        <i class="icon" :class="{ 'icon-close-outline': menuVisible, 'icon-menu-outline': !menuVisible }" @click="menuVisible = !menuVisible"></i>
      </transition>
    </div>
  </div>
</div>

<transition name="fade">
  <div class="menu-container" style="display: none;" v-show="menuVisible">
    <div class="menu-list">
      
        
          <a href="/" class="menu purple-link">
            首页
          </a>
        
      
        
          <a href="/archives" class="menu purple-link">
            归档
          </a>
        
      
        
          <a href="/tags" class="menu purple-link">
            标签
          </a>
        
      
        
          <a href="/post/about" class="menu purple-link">
            关于
          </a>
        
      
    </div>
  </div>
</transition>


      <div class="content-container">
        <div class="post-detail">
          
          <h2 class="post-title">使用 Kubeadm 快速创建 K8S 集群</h2>
          <div class="post-info post-detail-info">
            <span><i class="icon-calendar-outline"></i> 2020-02-08</span>
            
              <span>
                <i class="icon-pricetags-outline"></i>
                
                  <a href="https://m01i0ng.js.org/tag/LbGnNImX8">
                    k8s
                    
                      ，
                    
                  </a>
                
                  <a href="https://m01i0ng.js.org/tag/sPUrg8x7B">
                    Docker
                    
                  </a>
                
              </span>
            
          </div>
          <div class="post-content">
            <h2 id="环境架构">环境架构</h2>
<h3 id="服务器">服务器</h3>
<ul>
<li>192.168.1.220 k8s-master</li>
<li>192.168.1.221 k8s-node-1</li>
<li>192.168.1.223 k8s-node-2</li>
</ul>
<h3 id="系统centos-74">系统：centos 7.4</h3>
<h3 id="集群部署方式kubeadm">集群部署方式：kubeadm</h3>
<h2 id="系统配置">系统配置</h2>
<h3 id="配置主机映射">配置主机映射</h3>
<p>所有节点</p>
<pre><code class="language-bash">cat &gt; /etc/hosts &lt;&lt; EOF
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6

192.168.1.220 k8s-master
192.168.1.221 k8s-node-1
192.168.1.223 k8s-node-2
EOF
</code></pre>
<h3 id="禁用-selinux">禁用 selinux</h3>
<p>所有节点</p>
<pre><code class="language-bash">sed -i &quot;s/^SELINUX=enforcing/SELINUX=disabled/g&quot; /etc/sysconfig/selinux
sed -i &quot;s/^SELINUX=enforcing/SELINUX=disabled/g&quot; /etc/selinux/config
sed -i &quot;s/^SELINUX=permissive/SELINUX=disabled/g&quot; /etc/sysconfig/selinux
sed -i &quot;s/^SELINUX=permissive/SELINUX=disabled/g&quot; /etc/selinux/config
setenforce 0
</code></pre>
<h3 id="禁用防火墙">禁用防火墙</h3>
<p>所有节点</p>
<pre><code class="language-bash">systemctl disable firewalld &amp;&amp; systemctl stop firewalld
</code></pre>
<h3 id="关闭交换分区">关闭交换分区</h3>
<p>所有节点</p>
<pre><code class="language-bash">sed -i 's/.*swap.*/#&amp;/' /etc/fstab
swapoff -a
</code></pre>
<h3 id="配置转发参数">配置转发参数</h3>
<p>所有节点</p>
<pre><code class="language-bash">cat &gt; /etc/sysctl.d/k8s.conf &lt;&lt; EOF
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
vm.swappiness=0
EOF
sysctl --system
</code></pre>
<h3 id="加载-ipvs-相关内核模块">加载 ipvs 相关内核模块</h3>
<p>所有节点</p>
<pre><code class="language-bash"># 如果重新开机，需要重新加载
modprobe ip_vs
modprobe ip_vs_rr
modprobe ip_vs_wrr
modprobe ip_vs_sh
modprobe nf_conntrack_ipv4
lsmod | grep ip_vs
</code></pre>
<h2 id="安装配置-docker">安装配置 Docker</h2>
<p>k8s v1.11.0 版本推荐使用 Docker v17.03，经测试 v1.13 也能正常使用，而最新的 v18.05 会产生警告，并无法使用资源限制</p>
<h3 id="安装-docker">安装 Docker</h3>
<p>所有节点</p>
<pre><code class="language-bash">yum install -y docker &amp;&amp;\
systemctl enable docker &amp;&amp;\
systemctl start docker
</code></pre>
<h3 id="配置国内镜像">配置国内镜像</h3>
<p>所有节点</p>
<pre><code class="language-bash">cat &gt; /etc/docker/daemon.json &lt;&lt; EOF
{
  &quot;registry-mirrors&quot;: [&quot;https://docker.mirrors.ustc.edu.cn/&quot;]
}
EOF
systemctl daemon-reload
systemctl restart docker
</code></pre>
<h2 id="安装配置-kubernetes">安装配置 Kubernetes</h2>
<h3 id="安装-kubernetes">安装 Kubernetes</h3>
<p>所有节点</p>
<pre><code class="language-bash"># 配置源
cat &gt; /etc/yum.repos.d/kubernetes.repo &lt;&lt; EOF
[kubernetes]
name=Kubernetes
baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
enabled=1
gpgcheck=1
repo_gpgcheck=1
gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
EOF

# 安装
yum install -y kubelet kubeadm kubectl ipvsadm
</code></pre>
<h3 id="配置启动-kubelet">配置启动 Kubelet</h3>
<p>所有节点</p>
<pre><code class="language-bash"># 配置kubelet使用国内pause镜像
# 配置kubelet的cgroups
# 获取docker的cgroups
DOCKER_CGROUPS=$(docker info | grep 'Cgroup' | cut -d' ' -f3)
echo $DOCKER_CGROUPS
cat &gt; /etc/sysconfig/kubelet &lt;&lt; EOF
KUBELET_EXTRA_ARGS=&quot;--cgroup-driver=$DOCKER_CGROUPS --pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com/google_containers/pause-amd64:3.1&quot;
EOF

# 启动
systemctl daemon-reload
systemctl enable kubelet &amp;&amp; systemctl start kubelet
</code></pre>
<h3 id="配置-master-节点">配置 master 节点</h3>
<p>master 节点</p>
<pre><code class="language-bash"># 生成配置文件
cat &gt; kubeadm-master.config &lt;&lt; EOF
apiVersion: kubeadm.k8s.io/v1alpha2
kind: MasterConfiguration
kubernetesVersion: v1.11.0
imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers
api:
  # master 节点 ip
  advertiseAddress: 192.168.1.220

controllerManagerExtraArgs:
  node-monitor-grace-period: 10s
  pod-eviction-timeout: 10s

networking:
  podSubnet: 10.244.0.0/16

kubeProxy:
  config:
    # mode: ipvs
    mode: iptables
EOF
</code></pre>
<pre><code class="language-bash"># 提前拉取镜像，如果失败可以多次尝试
kubeadm config images pull --config kubeadm-master.config
</code></pre>
<pre><code class="language-bash"># 启动
kubeadm init --config kubeadm-master.config
</code></pre>
<p>如以上命令没有出错，会出现类似 <code>kubeadm --join xxx</code> 的说明</p>
<pre><code class="language-bash">rm -rf $HOME/.kube
mkdir -p $HOME/.kube
cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
chown $(id -u):$(id -g) $HOME/.kube/config
</code></pre>
<p>执行 <code>kubectl get nodes</code> 查看节点，此时状态应该为 NotReady，接着开始配置 <code>flannel</code> 网络插件</p>
<pre><code class="language-bash"># 修改镜像
wgte https://raw.githubusercontent.com/coreos/flannel/v0.10.0/Documentation/kube-flannel.yml
sed -i 's/k8s.gcr.io/registry.cn-shanghai.aliyuncs.com\/gcr-k8s/g' kube-flannel.yaml
</code></pre>
<pre><code class="language-bash"># 部署
kubectl apply -f kube-flannel.yml
</code></pre>
<p>查看（需要时间配置，可反复执行第一条查看直到 <code>pods</code> 状态全为 <code>Running</code>）</p>
<pre><code class="language-bash">kubectl get po -n kube-system
kubectl get svc -n kube-system
</code></pre>
<p>配置好网络之后 kubeadm 会自动部署 coredns，再执行 <code>kubectl get nodes</code>，此时 <code>master</code> 节点状态应该为 <code>Ready</code></p>
<h3 id="配置子节点">配置子节点</h3>
<p>node-1、node-2 节点</p>
<p><code>master</code> 节点执行 <code>kubeadm token create --print-join-command</code>，将结果复制，到 <code>node</code> 上执行，加入集群，如果执行失败可能是 <code>selinux</code> 没关（我在此处困了很久……），最后在 <code>master</code> 节点执行 <code>kubectl get node</code>，应该会看见加入进来的节点</p>
<h2 id="测试集群">测试集群</h2>
<p>master 节点</p>
<p>部署 deploy</p>
<pre><code class="language-bash">kubectl run nginx --replicas=2 --image=nginx:alpine --port=80
kubectl expose deployment nginx --type=NodePort --name=test-service-nodeport
kubectl expose deployment nginx --name=test-service

kubectl describe svc test-service
</code></pre>
<p>访问测试，32340 为上面最后一条命令查看 svc 时获取的端口</p>
<p>浏览器打开 <code>http://&lt;master-ip&gt;:&lt;32340&gt;</code> 会返回 nginx 的欢迎界面</p>
<p>清理删除</p>
<pre><code class="language-bash">kubectl delete svc test-service test-service-nodeport
kubectl delete deploy nginx
</code></pre>
<h2 id="结束">结束</h2>
<ul>
<li>部署完成之后想增加节点只要按照子节点部署的步骤进行即可，之后可以参考官方文档安装 <code>dashboard heapster</code> 等插件</li>
<li>此为单主多子节点配置，多主多子配置方法有所不同，日后再说--</li>
</ul>

          </div>
        </div>

        
          <div class="next-post">
            <a class="purple-link" href="https://m01i0ng.js.org/post/docker-jing-xiang-de-fen-jie-duan-gou-jian">
              <h3 class="post-title">
                下一篇：Docker 镜像的分阶段构建
              </h3>
            </a>
          </div>
          
      </div>

      
        
          <div id="gitalk-container"></div>
        

        
      

      <div class="site-footer">
  <div class="slogan">温故而知新</div>
  <div class="social-container">
    
      
    
      
    
      
    
      
    
      
    
  </div>
  Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a> | <a class="rss" href="https://m01i0ng.js.org/atom.xml" target="_blank">RSS</a>
</div>


    </div>
    <script type="application/javascript">

hljs.initHighlightingOnLoad()

var app = new Vue({
  el: '#app',
  data: {
    menuVisible: false,
  },
})

</script>



  
    <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
    <script>

      var gitalk = new Gitalk({
        clientID: '4fc683c05fc3ba5bcf66',
        clientSecret: 'eaf39a9547e39a17b74ee130e79385f8117827ae',
        repo: 'm01i0ng.github.io',
        owner: 'm01i0ng',
        admin: ['m01i0ng'],
        id: (location.pathname).substring(0, 49),      // Ensure uniqueness and length less than 50
        distractionFreeMode: false  // Facebook-like distraction free mode
      })

      gitalk.render('gitalk-container')

    </script>
  

  




  </body>
</html>
